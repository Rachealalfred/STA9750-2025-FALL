---
title: "Mini-Project 03 - Visualizing and Maintaining the Green Canopy of NYC"
author: "Racheal"
date: today
format: html
execute:
  message: false
  warning: false
  cache: false
---

![](https://www.untappedcities.com/content/images/wp-content/uploads/2020/09/central-park-trees-grove-of-american-elms-central-park-mall-literary-walk-great-trees-nyc10.jpg)

## Introduction

This project examines NYC street trees to propose a health-focused tree replacement initiative.

---

## Data Collection

```{r setup}
library(sf)
library(dplyr)
library(ggplot2)

data_dir <- "data/mp03"
if (!dir.exists(data_dir)) dir.create(data_dir, recursive = TRUE)
```

### NYC City Council Districts

```{r download-districts}
download_districts <- function() {
  geojson_file <- file.path(data_dir, "districts.geojson")
  
  if (file.exists(geojson_file)) {
    message("Reading cached districts...")
    return(st_read(geojson_file, quiet = TRUE))
  }
  
  urls <- c(
    "https://data.cityofnewyork.us/api/geospatial/yusd-j4xi?method=export&format=GeoJSON",
    "https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_City_Council_Districts/FeatureServer/0/query?where=1=1&outFields=*&outSR=4326&f=geojson"
  )
  
  for (url in urls) {
    message("Trying: ", substring(url, 1, 50), "...")
    districts <- tryCatch(st_read(url, quiet = TRUE), error = function(e) NULL)
    
    if (!is.null(districts) && nrow(districts) > 0) {
      message("Success! ", nrow(districts), " districts")
      st_write(districts, geojson_file, quiet = TRUE)
      return(districts)
    }
  }
  
  stop("Could not download districts")
}

nyc_districts <- download_districts()
nyc_districts <- st_transform(nyc_districts, 4326)

# Find district ID column
dist_cols <- names(nyc_districts)
message("Available columns: ", paste(dist_cols, collapse = ", "))

# Try to find the district column
district_col <- NULL
for (col in c("coun_dist", "CounDist", "council_district", "district", "DISTRICT", "BoroCD")) {
  if (col %in% dist_cols) {
    district_col <- col
    break
  }
}

if (is.null(district_col)) {
  # Use first column that looks like a district ID
  district_col <- dist_cols[grepl("dist|council", dist_cols, ignore.case = TRUE)][1]
  if (is.na(district_col)) district_col <- dist_cols[1]
}

message("Using district column: ", district_col)

# Rename to standard name
nyc_districts <- nyc_districts |>
  rename(district_id = !!sym(district_col))

message("Loaded ", nrow(nyc_districts), " districts")
```

### Street Tree Data

```{r download-trees}
#| cache: true

download_trees <- function() {
  all_trees <- list()
  
  base_urls <- c(
    "https://data.cityofnewyork.us/resource/5rq2-4hqu.geojson",
    "https://data.cityofnewyork.us/resource/nwxe-4ae8.geojson"
  )
  
  for (base_url in base_urls) {
    message("Trying: ", base_url)
    
    for (batch in 0:19) {
      offset <- batch * 50000
      file <- file.path(data_dir, paste0("trees_", offset, ".geojson"))
      
      if (file.exists(file)) {
        trees <- st_read(file, quiet = TRUE)
      } else {
        url <- paste0(base_url, "?$limit=50000&$offset=", offset)
        trees <- tryCatch(st_read(url, quiet = TRUE), error = function(e) NULL)
        
        if (!is.null(trees) && nrow(trees) > 0) {
          st_write(trees, file, quiet = TRUE)
        }
      }
      
      if (is.null(trees) || nrow(trees) == 0) break
      
      all_trees[[batch + 1]] <- trees
      message("Batch ", batch, ": ", format(nrow(trees), big.mark = ","))
      if (nrow(trees) < 50000) break
    }
    
    if (length(all_trees) > 0) break
  }
  
  if (length(all_trees) == 0) stop("Could not download trees")
  
  do.call(rbind, all_trees)
}

tree_points <- download_trees()
tree_points <- st_transform(tree_points, 4326)
message("Total trees: ", format(nrow(tree_points), big.mark = ","))
```

---

## Spatial Analysis

```{r spatial-join}
trees_with_districts <- st_join(
  tree_points, 
  nyc_districts |> select(district_id),
  join = st_within
)

n_assigned <- sum(!is.na(trees_with_districts$district_id))
message("Trees assigned: ", format(n_assigned, big.mark = ","))
```

### District Summary

```{r district-summary}
district_summary <- trees_with_districts |>
  st_drop_geometry() |>
  filter(!is.na(district_id)) |>
  group_by(district_id) |>
  summarise(
    total_trees = n(),
    unique_species = n_distinct(spc_common, na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(desc(total_trees))

head(district_summary, 15) |>
  knitr::kable(
    format.args = list(big.mark = ","),
    col.names = c("District", "Total Trees", "Unique Species"),
    caption = "Top 15 Districts by Tree Count"
  )
```

---

## Tree Health Analysis

```{r health-analysis}
health_analysis <- trees_with_districts |>
  st_drop_geometry() |>
  filter(!is.na(district_id), !is.na(health)) |>
  group_by(district_id, health) |>
  summarise(count = n(), .groups = "drop") |>
  group_by(district_id) |>
  mutate(total = sum(count), pct = round(100 * count / total, 1))

poor_health <- health_analysis |>
  filter(health %in% c("Dead", "Poor")) |>
  group_by(district_id) |>
  summarise(
    total_trees = first(total),
    dead_poor_pct = sum(pct),
    .groups = "drop"
  ) |>
  arrange(desc(dead_poor_pct))

head(poor_health, 15) |>
  knitr::kable(
    format.args = list(big.mark = ","),
    col.names = c("District", "Total Trees", "Dead/Poor %"),
    caption = "Districts with Most Dead/Poor Trees"
  )
```

### Top Species

```{r top-species}
top_species <- trees_with_districts |>
  st_drop_geometry() |>
  filter(!is.na(spc_common)) |>
  count(spc_common, sort = TRUE) |>
  head(15)

ggplot(top_species, aes(y = reorder(spc_common, n), x = n)) +
  geom_col(fill = "forestgreen") +
  scale_x_continuous(labels = scales::comma) +
  labs(title = "Most Common Street Tree Species in NYC",
       x = "Number of Trees", y = NULL) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

---

## Focus: District 30 (Queens)

```{r district30}
# Find District 30 (try different formats)
d30_ids <- c("30", 30, "District 30", "30.0")
d30_trees <- trees_with_districts |>
  filter(as.character(district_id) %in% as.character(d30_ids))

if (nrow(d30_trees) == 0) {
  # Show available districts to help identify
  available <- unique(trees_with_districts$district_id)
  message("Available districts: ", paste(head(available, 20), collapse = ", "))
  
  # Try to find something close to 30
  d30_trees <- trees_with_districts |>
    filter(grepl("30", as.character(district_id)))
}

message("District 30: ", format(nrow(d30_trees), big.mark = ","), " trees")
```

### Analysis

```{r categorize-d30}
d30_analysis <- d30_trees |>
  st_drop_geometry() |>
  mutate(
    health_status = case_when(
      health == "Dead" ~ "Dead",
      health == "Poor" ~ "Poor",
      health == "Fair" ~ "Fair",
      health == "Good" ~ "Good",
      TRUE ~ "Unknown"
    ),
    species_type = case_when(
      spc_common %in% c("pin oak", "red oak", "willow oak", "white oak", 
                        "American sweetgum", "black oak") ~ "High-Isoprene",
      spc_common %in% c("ginkgo", "honeylocust", "Callery pear", 
                        "Japanese zelkova") ~ "Beneficial",
      TRUE ~ "Moderate"
    )
  )

d30_stats <- d30_analysis |>
  summarise(
    total = n(),
    dead = sum(health_status == "Dead", na.rm = TRUE),
    poor = sum(health_status == "Poor", na.rm = TRUE),
    high_isoprene = sum(species_type == "High-Isoprene", na.rm = TRUE),
    beneficial = sum(species_type == "Beneficial", na.rm = TRUE)
  ) |>
  mutate(
    pct_dead = round(100 * dead / total, 1),
    pct_poor = round(100 * poor / total, 1)
  )
```

### District 30 Statistics

```{r d30-table}
data.frame(
  Metric = c("Total Trees", "Dead Trees", "Poor Trees", 
             "High-Isoprene Species", "Beneficial Species"),
  Count = format(c(d30_stats$total, d30_stats$dead, d30_stats$poor,
                   d30_stats$high_isoprene, d30_stats$beneficial), big.mark = ","),
  Percentage = c("100%", 
                 paste0(d30_stats$pct_dead, "%"),
                 paste0(d30_stats$pct_poor, "%"),
                 paste0(round(100*d30_stats$high_isoprene/d30_stats$total,1), "%"),
                 paste0(round(100*d30_stats$beneficial/d30_stats$total,1), "%"))
) |>
  knitr::kable(caption = "District 30 Tree Health Summary")
```

### Top Species in District 30

```{r d30-species}
d30_analysis |>
  count(spc_common, species_type, sort = TRUE) |>
  head(15) |>
  knitr::kable(
    format.args = list(big.mark = ","),
    col.names = c("Species", "Category", "Count"),
    caption = "Top 15 Species in District 30"
  )
```

---

## Policy Proposal

### Executive Summary

**Target:** District 30, Queens  
**Action:** Replace **`r format(d30_stats$dead, big.mark = ",")`** dead trees (`r d30_stats$pct_dead`%)  
**Strategy:** Health-optimized, low-allergen species  
**Budget:** Routine maintenance (no new funding)

### The Problem

1. **Dead Trees:** `r format(d30_stats$dead, big.mark = ",")` trees with zero environmental benefit
2. **Air Quality:** High-isoprene species contribute to ozone formation
3. **Public Health:** Queens asthma rate of 11.5%

### Recommended Species

| Species | Isoprene | Allergens | Urban Tolerance | Mix |
|---------|----------|-----------|-----------------|-----|
| Ginkgo | Near-zero | Very low | Excellent | 40% |
| Honey Locust | Low | Low | Excellent | 35% |
| Callery Pear | Low | Low | Very good | 25% |

**Why These Species:**
- NYC Parks approved
- Proven survival rates
- Climate resilient
- Low maintenance
- Minimal allergens

### Implementation

**Phase 1 (Months 1-18):** Replace all `r format(d30_stats$dead, big.mark = ",")` dead trees

**Phase 2 (Years 2-3):** Replace ~500 poor-condition high-isoprene trees

**Phase 3 (Years 3-5):** Opportunistic replacement (~300/year)

### Why This Works

**Political Feasibility:**
- Existing budget
- No healthy tree removal
- Equitable distribution
- Proven species

**Health Impact:**
- Reduced ozone
- Lower allergens
- Fewer asthma episodes
- Better air quality

**Cost-Effectiveness:**
- Zero new funding
- Maintenance → health intervention
- Long-term healthcare savings
- Property value gains

### Geographic Distribution

```{r neighborhoods}
if ("nta_name" %in% names(d30_trees)) {
  d30_trees |>
    st_drop_geometry() |>
    filter(health == "Dead", !is.na(nta_name)) |>
    count(nta_name, sort = TRUE) |>
    head(10) |>
    knitr::kable(
      col.names = c("Neighborhood", "Dead Trees"),
      format.args = list(big.mark = ","),
      caption = "Dead Trees by Neighborhood"
    )
} else {
  cat("Dead trees distributed throughout District 30\n")
}
```

---

## Conclusion

Strategic tree replacement in District 30 is a **cost-neutral public health intervention**.

### Key Recommendation

Adopt health-optimized species selection for all dead tree replacements citywide, starting with District 30's **`r format(d30_stats$dead, big.mark = ",")`** priority trees.

### Expected Outcomes

- Improved respiratory health for 200,000+ residents
- Reduced summer ozone
- Lower allergen burden
- Citywide model program

---

## Data Sources

**Primary Data:**
- NYC Street Tree Census (2015), NYC Parks
- NYC Council Districts, City Planning

**Health Data:**
- NYC Community Health Survey (DOHMH)
- EPA Air Quality Index

**Methods:**
- Coordinate system: WGS84 (EPSG:4326)
- Software: R 4.3+, sf package
- Isoprene threshold: >10 μg C g⁻¹ h⁻¹



